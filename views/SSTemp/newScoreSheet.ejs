<div class="container my-4 border border-black border-1 border-opacity-10 rounded p-3 shadow bg-primary bg-opacity-10" style="max-width: 80vh;">
  <h1 class="text-center mb-3">New Template</h1>

  <!-- Confirm Modal -->
  <div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-hidden="true" style="backdrop-filter: blur(5px);">
    <div class="modal-dialog" role="document" style="margin-top: 2rem;">
      <div class="modal-content border-0 shadow">
        <div class="modal-header">
          <h5 class="modal-title" id="confirmModalLabel">Megerősítés</h5>
          <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="confirmMessage"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-dark" id="confirmCancel" data-bs-dismiss="modal">Mégsem</button>
          <button type="button" class="btn btn-danger" id="confirmOk">Igen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Prompt Modal -->
  <div class="modal fade" id="promptModal" tabindex="-1" role="dialog" aria-hidden="true" style="backdrop-filter: blur(5px);">
    <div class="modal-dialog" role="document" style="margin-top: 2rem;">
      <div class="modal-content border-0 shadow">
        <div class="modal-header">
          <h5 class="modal-title" id="promptModalLabel">Adatok megadása</h5>
          <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="promptMessage"></p>
          <input type="text" class="form-control" id="promptInput">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-dark" id="promptCancel" data-bs-dismiss="modal">Mégsem</button>
          <button type="button" class="btn btn-primary" id="promptOk">OK</button>
        </div>
      </div>
    </div>
  </div>

  <form action="/scoresheets/create" method="POST" enctype="multipart/form-data">
    <div class="row justify-content-center g-3 m-auto">



      <div class="col-md-12 bg-secondary bg-opacity-10 p-3 rounded">
        <label class="form-label mb-2">Test Type</label>
        <div class="row">
          <div class="col-md-6 col-lg-4 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="checkbox"
                     name="TestType[]" 
                     value="compulsory"
                     id="test_compulsory"
                     <%= formData && formData.TestType && (formData.TestType === 'compulsory' || (Array.isArray(formData.TestType) && formData.TestType.includes('compulsory'))) ? 'checked' : '' %>>
              <label class="form-check-label" for="test_compulsory">
                Compulsory
              </label>
            </div>
          </div>
          <div class="col-md-6 col-lg-4 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="checkbox"
                     name="TestType[]" 
                     value="freestyle"
                     id="test_freestyle"
                     <%= formData && formData.TestType && (formData.TestType === 'freestyle' || (Array.isArray(formData.TestType) && formData.TestType.includes('freestyle'))) ? 'checked' : '' %>>
              <label class="form-check-label" for="test_freestyle">
                Freestyle
              </label>
            </div>
          </div>
          <div class="col-md-6 col-lg-4 mb-2">
            <div class="form-check">
              <input class="form-check-input" type="checkbox"
                     name="TestType[]" 
                     value="technical"
                     id="test_technical"
                     <%= formData && formData.TestType && (formData.TestType === 'technical' || (Array.isArray(formData.TestType) && formData.TestType.includes('technical'))) ? 'checked' : '' %>>
              <label class="form-check-label" for="test_technical">
                Technical
              </label>
            </div>
          </div>
        </div>
      </div>



      <!-- Categories -->
      <div class="col-md-12 bg-secondary bg-opacity-10 p-3 rounded">
        <label class="form-label mb-2">Categories</label>
        <div class="row">
          <% const selected = formData && formData.CategoryId ? formData.CategoryId.map(x => x._id.toString()) : []; %>
          <% categorys.forEach(category => { %>
            <div class="col-md-6 col-lg-4 mb-2">
              <div class="form-check">
                <input class="form-check-input" type="checkbox"
                       name="Category[]" 
                       value="<%= category._id %>"
                       id="cat_<%= category._id %>"
                       <%= selected.includes(category._id.toString()) ? 'checked' : '' %>>
                <label class="form-check-label" for="cat_<%= category._id %>">
                  <%= category.CategoryDispName %>
                </label>
              </div>
            </div>
          <% }); %>
        </div>
      </div>

            <!-- Number Of judges -->
            <div class="col-md-12">
        <div class="form-floating">
          <select class="form-select shadow-none" id="numberOfJudges" name="numberOfJudges" required>
            <option value="">Select number of judges</option>
            <option value="1" <%= formData && formData.numberOfJudges === 1 ? 'selected' : '' %>>1</option>
            <option value="2" <%= formData && formData.numberOfJudges === 2 ? 'selected' : '' %>>2</option>
            <option value="4" <%= formData && formData.numberOfJudges === 4 ? 'selected' : '' %>>4</option>
            <option value="6" <%= formData && formData.numberOfJudges === 6 ? 'selected' : '' %>>6</option>
            <option value="8" <%= formData && formData.numberOfJudges === 8 ? 'selected' : '' %>>8</option>


          </select>
          <label for="numberOfJudges">Number of Judges</label>
        </div>
      </div>
            <div class="col-md-12">
        <div class="form-floating">
          <select class="form-select shadow-none" id="typeOfScores" name="typeOfScores" required>
            <option value="">Select score type</option>
            <option value="horse" <%= formData && formData.typeOfScores === 'horse' ? 'selected' : '' %>>Horse</option>
            <option value="artistic" <%= formData && formData.typeOfScores === 'artistic' ? 'selected' : '' %>>Artistic</option>
            <option value="technical" <%= formData && formData.typeOfScores === 'technical' ? 'selected' : '' %>>Technical</option>
            <option value="compulsory" <%= formData && formData.typeOfScores === 'compulsory' ? 'selected' : '' %>>Compulsory</option>
          </select>
          <label for="typeOfScores">Type of Scores</label>
        </div>
      </div>

      <!-- Background image upload -->
      <div class="col-md-12 border border-black border-opacity-25 rounded p-2">
        <label class="form-label">Background image</label>
        <input type="file" class="form-control" id="bgImageFile" name="bgImageFile" accept="image/*">
        <input type="hidden" name="bgImage" id="bgImageUrl" value="<%= formData?.bgImage || '' %>">
      </div>

      <!-- Canvas editor -->
      <div class="col-md-12 mt-3 border border-black border-opacity-25 rounded pt-2">
        <div >
          <div class="d-flex gap-2 mb-2 ">
          <select id="fieldType" class="form-select" style="max-width: 180px;">
            <option value="input">Input field</option>
            <option value="output">Output field</option>
          </select>
          <input id="fieldName" class="form-control" placeholder="Field name">
          <input id="fieldIdOrContent" class="form-control" placeholder="ID (input) / ContentID (output)">
          <input id="fieldWidth" class="form-control" type="number" placeholder="Width (%)" value="100" min="1">
          </div>
          <div class="d-flex gap-2 mb-2 w-100 ">
          <button type="button" class="btn btn-secondary w-50" id="addFieldBtn">Add field</button>
          <button type="button" class="btn btn-outline-danger w-50" id="clearAllBtn">Clear all</button>
          </div>
        </div>
<hr>
        <div id="imageStageWrapper" class=" position-relative" style="width: 100%; max-width: 800px; margin: 0 auto;">
          <img id="bgImage" src="<%= formData?.bgImage || '' %>" alt="Background" style="width: 100%; height: auto; display: none;">
          <!-- Draggable field overlays will be appended here -->
        </div>
        <!-- Hidden JSON outputs -->
        <input type="hidden" name="outputFieldList" id="outputFieldListJson">
        <input type="hidden" name="inputFieldList" id="inputFieldListJson">
      </div>

      <!-- Submit Button -->
      <div class="col-md-12 mt-3">
        <button type="submit" class="btn btn-primary w-100">New template</button>
      </div>

    </div>
  </form>
</div>

<script>
  // Modal helper functions
  function showConfirm(message) {
    return new Promise((resolve) => {
      const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
      document.getElementById('confirmMessage').textContent = message;
      
      const okBtn = document.getElementById('confirmOk');
      const cancelBtn = document.getElementById('confirmCancel');
      
      const cleanup = () => {
        okBtn.removeEventListener('click', handleOk);
        cancelBtn.removeEventListener('click', handleCancel);
      };
      
      const handleOk = () => {
        cleanup();
        modal.hide();
        resolve(true);
      };
      
      const handleCancel = () => {
        cleanup();
        modal.hide();
        resolve(false);
      };
      
      okBtn.addEventListener('click', handleOk);
      cancelBtn.addEventListener('click', handleCancel);
      
      modal.show();
    });
  }

  function showPrompt(message, defaultValue = '') {
    return new Promise((resolve) => {
      const modal = new bootstrap.Modal(document.getElementById('promptModal'));
      document.getElementById('promptMessage').textContent = message;
      document.getElementById('promptInput').value = defaultValue;
      
      const inputEl = document.getElementById('promptInput');
      const okBtn = document.getElementById('promptOk');
      const cancelBtn = document.getElementById('promptCancel');
      
      const cleanup = () => {
        okBtn.removeEventListener('click', handleOk);
        cancelBtn.removeEventListener('click', handleCancel);
        inputEl.removeEventListener('keypress', handleEnter);
      };
      
      const handleOk = () => {
        const result = inputEl.value;
        cleanup();
        modal.hide();
        resolve(result);
      };
      
      const handleCancel = () => {
        cleanup();
        modal.hide();
        resolve(null);
      };
      
      const handleEnter = (e) => {
        if (e.key === 'Enter') handleOk();
      };
      
      okBtn.addEventListener('click', handleOk);
      cancelBtn.addEventListener('click', handleCancel);
      inputEl.addEventListener('keypress', handleEnter);
      
      modal.show();
      inputEl.focus();
      inputEl.select();
    });
  }

  // State
  const outputFields = <%- JSON.stringify(formData?.outputFieldList || []) %>.map(f => ({
    ...f,
    width: f.width || f.position?.w || 100
  }));
  const inputFields  = <%- JSON.stringify(formData?.inputFieldList  || []) %>.map(f => ({
    ...f,
    width: f.width || f.position?.w || 100
  }));

  const bgImageEl   = document.getElementById('bgImage');
  const bgImageFile = document.getElementById('bgImageFile');
  const bgImageUrl  = document.getElementById('bgImageUrl');
  const stage       = document.getElementById('imageStageWrapper');

  const fieldTypeSel = document.getElementById('fieldType');
  const fieldNameInp = document.getElementById('fieldName');
  const fieldIdOrContentInp = document.getElementById('fieldIdOrContent');
  const fieldWidthInp = document.getElementById('fieldWidth');
  const addFieldBtn  = document.getElementById('addFieldBtn');
  const clearAllBtn  = document.getElementById('clearAllBtn');

  const outputJsonInp = document.getElementById('outputFieldListJson');
  const inputJsonInp  = document.getElementById('inputFieldListJson');

  // Image upload: preview + URL handling
  bgImageFile.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const objUrl = URL.createObjectURL(file);
    bgImageEl.src = objUrl;
    bgImageEl.style.display = 'block';
  });

  // Initialize existing fields
  document.addEventListener('DOMContentLoaded', () => {
  if (bgImageUrl.value) {
    bgImageEl.src = bgImageUrl.value;
    bgImageEl.style.display = 'block';
  }
    renderAllFields();
    syncHiddenJson();
  });

  // Add field
  addFieldBtn.addEventListener('click', () => {
    const type = fieldTypeSel.value;
    const name = fieldNameInp.value.trim();
    const idOrContent = fieldIdOrContentInp.value.trim();
    const width = Math.max(1, parseFloat(fieldWidthInp.value) || 100);
    if (!name || !idOrContent) return;

    // Default position center (50%, 50%) with width
    if (type === 'input') {
      inputFields.push({ name, id: idOrContent, preDefValue: '', position: { x: 50, y: 50 }, width });
    } else {
      outputFields.push({ name, contentid: idOrContent, position: { x: 50, y: 50 }, width });
    }
    renderAllFields();
    syncHiddenJson();

    fieldNameInp.value = '';
    fieldIdOrContentInp.value = '';
    fieldWidthInp.value = '100';
  });

  clearAllBtn.addEventListener('click', async () => {
    const confirmed = await showConfirm('Biztos törlöd az összes mezőt?');
    if (!confirmed) return;
    inputFields.length = 0;
    outputFields.length = 0;
    renderAllFields();
    syncHiddenJson();
  });

  // Render fields as draggable overlays
  function renderAllFields() {
    Array.from(stage.querySelectorAll('.field-overlay')).forEach(el => el.remove());

    outputFields.forEach((f, idx) => {
      const el = createOverlayElement(f, 'output', idx);
      stage.appendChild(el);
    });
    inputFields.forEach((f, idx) => {
      const el = createOverlayElement(f, 'input', idx);
      stage.appendChild(el);
    });
  }

  // Create overlay with drag support, tooltip, double-click delete, and better visibility
  function createOverlayElement(field, kind, idx) {
    const { name, position, width } = field;
    const el = document.createElement('div');
    el.className = `field-overlay ${kind === 'input' ? 'overlay-input' : 'overlay-output'}`;
    el.textContent = name;

    el.style.position = 'absolute';
    el.style.cursor = 'move';
    el.style.userSelect = 'none';
    el.style.width = `${width || 100}%`;
    el.style.overflow = 'hidden';
    el.style.textAlign = 'center';

    // Accessibility and hover tooltip with full field data
    const tooltipData = kind === 'input'
      ? `Type: INPUT\nName: ${field.name}\nID: ${field.id}\nDefault: ${field.preDefValue || ''}\nX: ${Math.round(position?.x ?? 50)}%\nY: ${Math.round(position?.y ?? 50)}%\nWidth: ${width || 100}%\n\n[Right-click to adjust width]`
      : `Type: OUTPUT\nName: ${field.name}\nContentID: ${field.contentid}\nX: ${Math.round(position?.x ?? 50)}%\nY: ${Math.round(position?.y ?? 50)}%\nWidth: ${width || 100}%\n\n[Right-click to adjust width]`;
    el.title = tooltipData; // native tooltip

    // place by percentage
    placeByPercent(el, position);

    // drag handlers
    let dragging = false;
    let startX = 0, startY = 0;

    el.addEventListener('mousedown', (ev) => {
      // ignore drag if double-click selection just happened
      dragging = true;
      startX = ev.clientX;
      startY = ev.clientY;
      ev.preventDefault();
    });

    window.addEventListener('mouseup', () => { dragging = false; });

    window.addEventListener('mousemove', (ev) => {
      if (!dragging) return;
      const dx = ev.clientX - startX;
      const dy = ev.clientY - startY;
      startX = ev.clientX;
      startY = ev.clientY;

      const rect = bgImageEl.getBoundingClientRect();
      const curLeft = parseFloat(el.style.left);
      const curTop  = parseFloat(el.style.top);
      const newLeftPx = (curLeft / 100) * rect.width + dx;
      const newTopPx  = (curTop / 100) * rect.height + dy;

      const newX = clamp((newLeftPx / rect.width) * 100, 0, 100);
      const newY = clamp((newTopPx  / rect.height) * 100, 0, 100);

      el.style.left = `${newX}%`;
      el.style.top  = `${newY}%`;

      // update state + tooltip
      if (kind === 'input') {
        inputFields[idx].position.x = newX;
        inputFields[idx].position.y = newY;
      } else {
        outputFields[idx].position.x = newX;
        outputFields[idx].position.y = newY;
      }
      el.title = updateTooltip(kind, field, newX, newY, field.width || 100);
      syncHiddenJson();
    });

    // Right-click to modify width
    el.addEventListener('contextmenu', async (ev) => {
      ev.preventDefault();
      const currentWidth = field.width || 100;
      const newWidth = await showPrompt(`Új szélesség (%): [jelenlegi: ${currentWidth}%]`, currentWidth);
      if (newWidth === null) return;
      
      const widthVal = Math.max(1, parseFloat(newWidth) || currentWidth);
      field.width = widthVal;
      el.style.width = `${widthVal}%`;
      el.title = updateTooltip(kind, field, position.x, position.y, widthVal);
      syncHiddenJson();
    });

    // Double-click to delete a single field
    el.addEventListener('dblclick', async (ev) => {
      ev.preventDefault();
      const confirmed = await showConfirm(`Törlöd a(z) "${name}" mezőt?`);
      if (!confirmed) return;
      if (kind === 'input') {
        inputFields.splice(idx, 1);
      } else {
        outputFields.splice(idx, 1);
      }
      renderAllFields();
      syncHiddenJson();
    });

    return el;
  }

  function updateTooltip(kind, field, x, y, w) {
    return kind === 'input'
      ? `Type: INPUT\nName: ${field.name}\nID: ${field.id}\nDefault: ${field.preDefValue || ''}\nX: ${Math.round(x)}%\nY: ${Math.round(y)}%\nWidth: ${w}%\n\n[Right-click to adjust width]`
      : `Type: OUTPUT\nName: ${field.name}\nContentID: ${field.contentid}\nX: ${Math.round(x)}%\nY: ${Math.round(y)}%\nWidth: ${w}%\n\n[Right-click to adjust width]`;
  }

  function placeByPercent(el, pos) {
    // stage relative to img
    const rect = bgImageEl.getBoundingClientRect();
    el.style.left = `${clamp(pos?.x ?? 50, 0, 100)}%`;
    el.style.top  = `${clamp(pos?.y ?? 50, 0, 100)}%`;
  }

  function clamp(v, min, max) {
    return Math.min(max, Math.max(min, v));
  }

  function syncHiddenJson() {
    // Backend: JSON parse-olás; ha stringet küldünk, a router parse-olja
    outputJsonInp.value = JSON.stringify(outputFields);
    inputJsonInp.value  = JSON.stringify(inputFields);
  }
</script>

<style>
  #imageStageWrapper { overflow: hidden; }
  .field-overlay {
    padding: 0px 0px;
    transform: translate(-50%, -50%);
    white-space: nowrap;
    border: 2px solid rgba(0,0,0,0.25);
    box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    transition: transform 0.06s ease, box-shadow 0.06s ease, opacity 0.12s ease;
    border-radius: 6px;
  }
  .overlay-input {
    background: rgba(13,110,253,0.85);       /* Bootstrap primary-like */
    color: #fff;
  }
  .overlay-output {
    background: rgba(108,117,125,0.55);      /* Bootstrap secondary-like */
    color: #fff;
    line-height: 1;

  }
  .field-overlay:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    opacity: 0.95;
  }
  .field-overlay::after {
    /* small visual anchor dot at the position center */
    content: '';
    position: absolute;
    left: 50%;
    top: 50%;
    width: 6px;
    height: 6px;
    background: #000000;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    opacity: 0.9;
  }
</style>