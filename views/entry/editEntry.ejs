<div class="container my-4 border border-black border-1 border-opacity-10 rounded p-3 shadow bg-primary bg-opacity-10" style="max-width: 80vh;">
  <h1 class="text-center mb-3">Edit Entry</h1>

  <form action="/entry/edit/<%= formData._id %>" method="POST">
    <div class="row justify-content-center g-3 m-auto">
      
      <!-- Selected Event -->
      <div class="col-md-12 d-none">
        <div class="form-floating">
          <input type="text" id="event" name="event" required value="<%= selectedEvent?._id %>">
        </div>
      </div>

            <!-- Horse -->
      <div class="col-md-12">
        <div class="form-floating position-relative searchable-dropdown">
          <i class="bi bi-chevron-down position-absolute top-50 end-0 pe-3 translate-middle-y"></i>
          <input type="text" class="form-control shadow-none searchable-input"
                 placeholder="Search Horse"
                 autocomplete="off" 
                 <% if (formData) { %>
                 <% horses.forEach(element => { %>
                    <% if (String(element._id) === String(formData.horse._id)) { %>
                      value="<%= element.Horsename %>"
                    <% } %>
                 <% }) %>
                  <% }%>

                  >
          <label class="form-label">Horse</label>
          <!-- Hidden input for form submission -->
          <input type="hidden" class="searchable-hidden" name="horse"
                 value="<%= formData ? formData.horse._id : '' %>">

          <!-- Dropdown list -->
          <ul class="list-group position-absolute w-100 mt-1 shadow-sm d-none searchable-list" 
              style="max-height: 200px; overflow-y: auto; z-index: 1000;">
              <% horses.forEach(element => { %>
              <li class="list-group-item list-group-item-action searchable-item" val="<%= element._id %>" ><%= element.Horsename %></li>

            <% }) %>
          </ul>
        </div>
      </div>

      <div class="col-md-12">
        <div class="form-floating position-relative searchable-dropdown">
          <i class="bi bi-chevron-down position-absolute top-50 end-0 pe-3 translate-middle-y"></i>
          <input type="text" class="form-control shadow-none searchable-input"
                 placeholder="Search Lunger"
                 autocomplete="off" 
                 <% if (formData) { %>
                 <% lungers.forEach(element => { %>
                    <% if (String(element._id) === String(formData.lunger._id)) { %>
                      value="<%= element.Name %>"
                    <% } %>
                 <% }) %>
                  <% }%>

                  >
          <label class="form-label">Lunger</label>
          <!-- Hidden input for form submission -->
          <input type="hidden" class="searchable-hidden" name="lunger"
                 value="<%= formData ? formData.lunger._id : '' %>">

          <!-- Dropdown list -->
          <ul class="list-group position-absolute w-100 mt-1 shadow-sm d-none searchable-list" 
              style="max-height: 200px; overflow-y: auto; z-index: 1000;">
              <% lungers.forEach(element => { %>
              <li class="list-group-item list-group-item-action searchable-item" val="<%= element._id %>" ><%= element.Name %></li>

            <% }) %>
          </ul>
        </div>
      </div>

        <div class="col-md-12">
        <div class="form-floating position-relative searchable-dropdown">
          <i class="bi bi-chevron-down position-absolute top-50 end-0 pe-3 translate-middle-y "></i>
          <input type="text" class="form-control shadow-none searchable-input" disabled
                 placeholder="Search Category"
                 autocomplete="off" 
                 <% if (formData) { %>
                 <% categorys.forEach(element => { %>
                    <% if (String(element._id) === String(formData.category._id)) { %>
                      value="<%= element.CategoryDispName %>"
                    <% } %>
                 <% }) %>
                  <% }%>

                  >
          <label class="form-label">Category</label>
          <!-- Hidden input for form submission -->
          <input type="hidden" class="searchable-hidden" id="valueinput" name="category"
                 value="<%= formData ? formData.category._id : '' %>">

          <!-- Dropdown list -->
          <ul class="list-group position-absolute w-100 mt-1 shadow-sm d-none searchable-list" 
              style="max-height: 200px; overflow-y: auto; z-index: 1000;">
              <% categorys.forEach(element => { %>
              <li class="list-group-item list-group-item-action searchable-item" val="<%= element._id %>" ><%= element.CategoryDispName %></li>

            <% }) %>
          </ul>
        </div>
      </div>

      <% 
  const statusDisplayMap = {
    registered: 'Registered',
    withdrawn: 'Withdrawn',
    confirmed: 'Confirmed',
    cancelled: 'Cancelled'
  };
  const selectedStatusDisplay = formData && formData.status ? (statusDisplayMap[formData.status] || formData.status) : '';
%>
            <!-- Status -->
      <div class="col-md-12">
        <div class="form-floating position-relative searchable-dropdown">
          <i class="bi bi-chevron-down position-absolute top-50 end-0 pe-3 translate-middle-y"></i>
          <input type="text" class="form-control shadow-none searchable-input"
                 placeholder="Search Status"
                 autocomplete="off"
                 value="<%= selectedStatusDisplay %>">
          <label class="form-label">Status</label>
          <!-- Hidden input for form submission -->
          <input type="hidden" class="searchable-hidden" name="status"
                 value="<%= formData ? formData.status : '' %>">

          <!-- Dropdown list -->
          <ul class="list-group position-absolute w-100 mt-1 shadow-sm d-none searchable-list" 
              style="max-height: 200px; overflow-y: auto; z-index: 1000;">

              <li class="list-group-item list-group-item-action searchable-item" val="registered" >Registered</li>
              <li class="list-group-item list-group-item-action searchable-item" val="withdrawn" >Withdrawn</li>
              <li class="list-group-item list-group-item-action searchable-item" val="confirmed" >Confirmed</li>
              <li class="list-group-item list-group-item-action searchable-item" val="cancelled">Inactive</li>
          </ul>
        </div>
      </div>

      <div class="col-md-12"  id="teamNameDiv" style="display: none;">
        <div class="form-floating">
          <input type="text" class="form-control shadow-none" id="teamName" name="teamName" placeholder="Team Name"
                 value="<%= formData ? formData.teamName : '' %>" autocomplete="off" >
          <label for="teamName">Team Name</label>
        </div>
      </div>

      
      <!-- Vaulters felirat mindig látszik -->
      <div class="col-md-12 mt-5">
        <div class="position-relative border border-1 border-secondary rounded border-opacity-25 pt-3">
          <div 
            class="position-absolute border-secondary border-opacity-25 px-3"
            style="top: -25px; left: 24px; font-weight: bold; border-radius: 0.35rem 0.35rem 0 0; border: 1px solid #6c757d; border-bottom: none;">
            Vaulters
          </div>
          <div class="p-2" id="vaulterContainer"></div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="col-md-12 mt-3">
        <button type="submit" class="btn btn-primary w-100">Edit Entry</button>
      </div>

    </div>
  </form>
</div>
<script>
  // Map category ID to type
  const categoryTypeMap = {};
  <% categorys.forEach(cat => { %>
    categoryTypeMap["<%= cat._id %>"] = "<%= cat.Type %>";
  <% }); %>

  const vaulters = <%- JSON.stringify(vaulters) %>;
  const formVaulters = <%- JSON.stringify(formData && formData.vaulter ? formData.vaulter : []) %>;

  // Vaulter select template
  function getVaulterSelect(index, vaulters, formVaulters) {
    let options = '';
    let selected = {
          id :'',
          name : ''};
    vaulters.forEach(element => {
      if (
        formVaulters &&
        formVaulters[index] &&
        (
          formVaulters[index]._id === element._id ||
          formVaulters[index] === element._id
        )
      ) {
        selected = {
          id :formVaulters[index]._id,
          name : formVaulters[index].Name};
      }

      options += `<li class="list-group-item list-group-item-action searchable-item" val="${element._id}" >${element.Name}</li>`;
    });

      
    return `
    
    
      <div class="form-floating mb-2">
        <div class="form-floating position-relative searchable-dropdown">
          <i class="bi bi-chevron-down position-absolute top-50 end-0 pe-3 translate-middle-y"></i>
          <input type="text" class="form-control shadow-none searchable-input"
                 placeholder="Search Lunger"
                 autocomplete="off" 
                      value="${selected.name}">
          <label class="form-label">Select Vaulter ${index + 1}</label>
          <!-- Hidden input for form submission -->
          <input type="hidden" class="searchable-hidden" name="vaulter[]"
                 value="${selected.id}">

          <!-- Dropdown list -->
          <ul class="list-group position-absolute w-100 mt-1 shadow-sm d-none searchable-list" 
              style="max-height: 200px; overflow-y: auto; z-index: 1000;">
              ${options}
          </ul>
        </div>
      </div>

      `;
  }
  

  function renderVaulterInputs(count, formVaulters) {
    const vaulterContainer = document.getElementById('vaulterContainer');
    vaulterContainer.innerHTML = '';
    for (let i = 0; i < count; i++) {
      vaulterContainer.innerHTML += getVaulterSelect(i, vaulters, formVaulters);
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('valueinput');
    function updateVaulterInputs() {
      const selectedCategoryId = categorySelect.value;
      const teamNameDiv = document.getElementById('teamNameDiv');
      const type = categoryTypeMap[selectedCategoryId];
      if (type === 'Squad') {
        teamNameDiv.style.display = 'block';
        renderVaulterInputs(6, formVaulters);
      }
      else if (type === 'PDD') {
        teamNameDiv.style.display = 'none';
        renderVaulterInputs(2, formVaulters);
      }
      else if (type === 'Individual') {
        teamNameDiv.style.display = 'none';
        renderVaulterInputs(1, formVaulters);
      }
      else {
        teamNameDiv.style.display = 'none';
        document.getElementById('vaulterContainer').innerHTML = '';
      }
    }
    categorySelect.addEventListener('change', function() {
      // Ha a kategória változik, ne legyenek előre kiválasztott vaulterek
      const selectedCategoryId = categorySelect.value;
      const type = categoryTypeMap[selectedCategoryId];
      if (type === 'Squad') {
        teamNameDiv.style.display = 'block';
        renderVaulterInputs(6, []);
      }
      else if (type === 'PDD') {
        teamNameDiv.style.display = 'none';
        renderVaulterInputs(2, []);
      }
      else if (type === 'Individual') {
        teamNameDiv.style.display = 'none';
        renderVaulterInputs(1, []);
      }
      else {
        teamNameDiv.style.display = 'none';
        document.getElementById('vaulterContainer').innerHTML = '';
      }

      document.querySelectorAll('.searchable-dropdown').forEach(wrapper => {

         input = wrapper.querySelector('.searchable-input');
         hidden = wrapper.querySelector('.searchable-hidden');
         list = wrapper.querySelector('.searchable-list');
         items = list ? list.querySelectorAll('.searchable-item') : null;
         icon = wrapper.querySelector('.bi-chevron-down');
        
        if (input && hidden && list && items && typeof listCreator === 'function') {
          listCreator(input, hidden, list, items, icon);
        }
      });
    });
    updateVaulterInputs(); // Initial render with formVaulters
  });
</script>
