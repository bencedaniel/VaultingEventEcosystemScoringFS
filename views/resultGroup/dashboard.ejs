<div class="container my-4 border border-black border-1 border-opacity-25 rounded p-2" >
  <ul class="list-group">

    <li class="list-group-item border-0">
        <h3 class="text-center">Result Group Management</h3>
    </li>

  </ul>
<div class="d-flex justify-content-start align-items-center w-100 shadow-sm p-1 mb-4 bg-secondary bg-opacity-25 rounded border border-1 border-black border-opacity-10 flex-grow-1">

        <a href="/result/groups/new" class="btn btn-outline-primary w-50 me-1">Create New Result Group</a>
        <button type="button" class="btn btn-outline-success w-50 ms-1" data-bs-toggle="modal"
                data-bs-target="#genModal" data-horseid=""><i class="bi bi-plus-lg"></i> Generate Result Groups</button>

  </div>

<table class="table  table-bordered w-100 m-0" id="TableBody">
       <!-- <thead class="table-primary text-center">
            <tr>
                <th scope="col" colspan="3" >Category</th>

            </tr>
            <tr>
                <th scope="col" colspan="2" >Round 1 </th>
                <th scope="col" >Round 2 </th>
            </tr>
            <tr>
                <th scope="col" width="25%">First</th>
                <th scope="col" width="25%">Second</th>
                <th scope="col" width="50%">First</th>
            </tr>
        </thead>-->

        <tbody class="align-middle text-center"  >

            <% resultGroups.forEach(resultGroup => { %>

            <tr>
            <td colspan="3" class="p-0" >
            <table class="table table-bordered table-hover m-0 p-0 w-100">
                <tbody class="align-middle text-center">
            <tr>
                <td colspan="3"></select>Category: <%= resultGroup.category.CategoryDispName %></td>
                <td rowspan="4" colspan="1" class="border-2 border-black border-opacity-25" width="10%">
                     <a href="/result/groups/edit/<%= resultGroup._id %>" class="btn btn-warning btn-sm shadow-none m-1"><i class="bi bi-pen"></i></a>
          <button type="button" class="btn btn-danger btn-sm m-1" data-bs-toggle="modal"
                  data-bs-target="#deleteModal" data-horseid="<%= resultGroup._id %>"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
            <tr>
                <td colspan="2" >Round 1 -- <%= Number(resultGroup.calcTemplate.round1FirstP) + Number(resultGroup.calcTemplate.round1SecondP) %>%</td>
                <td colspan="1">Round 2 -- <%= resultGroup.calcTemplate.round2FirstP %>%</td>
            </tr>
            <tr>
                <td colspan="1" width="22.5%">  <%= resultGroup.calcTemplate.round1FirstP  %>% -- First program:</td>
                <td colspan="1" width="22.5%"><%= resultGroup.calcTemplate.round1SecondP  %>% -- Second program:</td>
                <td colspan="1"width="45%"><%= resultGroup.calcTemplate.round2FirstP %>% -- First program:</td>
            </tr>
            <tr>
                <td colspan="1" width="22.5%"> <%= resultGroup.round1First?.dailytimetable.DayName %> - <%= resultGroup.round1First?.Name %></td>
                <td colspan="1"width="22.5%"><%= resultGroup.round1Second?.dailytimetable.DayName %> - <%= resultGroup.round1Second?.Name %></td>
                <td colspan="1"width="45%"><%= resultGroup.round2First?.dailytimetable.DayName %> - <%= resultGroup.round2First?.Name %></td>
            </tr>
            </tbody>
            </table>
            </td>
            </tr>
                                        <tr><td colspan="4" class="bg-primary bg-opacity-10" height="50px"></td></tr>

            <% }) %>

        </tbody>
    </table>

<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel"
    aria-hidden="true" style="backdrop-filter: blur(5px);">
    <div class="modal-dialog" role="document">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Delete result group</h5>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="deleteConfirmationText">Are you sure you want to delete this result group?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">Delete</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="genModal" tabindex="-1" role="dialog" aria-labelledby="genModalLabel"
    aria-hidden="true" style="backdrop-filter: blur(5px);">
    <div class="modal-dialog" role="document">
        <div class="modal-content border-0 shadow">
            <div class="modal-header">
                <h5 class="modal-title" id="genModalLabel">Delete result group</h5>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="genConfirmationText">Are you sure you want to generate result groups?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmGenButton">Generate</button>
            </div>
        </div>
    </div>
</div>

<script>

    function updateGenerator(groupId, newStatus) {
        fetch('/result/group/status/' + groupId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ status: newStatus })
        }).then(response => {
            if (response.ok) {
                ShowSuccessToast('Generator updated successfully');
            } else {
                ShowErrorToast('Error updating group status');
                window.location.reload();
            }
        });
    }

document.addEventListener('DOMContentLoaded', function() {
    let IdToDelete = null;
    const deleteModal = document.getElementById('deleteModal');
    const confirmDeleteButton = document.getElementById('confirmDeleteButton');

    deleteModal?.addEventListener('show.bs.modal', event => {
        const button = event.relatedTarget;
        IdToDelete = button.getAttribute('data-horseid');
    });

    confirmDeleteButton?.addEventListener('click', () => {
        fetch('/result/groups/delete/' + IdToDelete, {
            method: 'DELETE'
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                window.location.reload();
            }
        });
    });
});

document.addEventListener('DOMContentLoaded', function() {
    const genModal = document.getElementById('genModal');
    const confirmGenButton = document.getElementById('confirmGenButton');

    genModal?.addEventListener('show.bs.modal', event => {
        const button = event.relatedTarget;
        IdToDelete = button.getAttribute('data-horseid');
    });

    confirmGenButton?.addEventListener('click', () => {
        fetch('/result/groups/generate', {
            method: 'POST'
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                window.location.reload();
            }
        });
    });
});
</script>
